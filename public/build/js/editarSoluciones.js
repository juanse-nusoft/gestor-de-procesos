document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("division"),t=document.getElementById("categoria");e.addEventListener("change",(function(){const e=this.value;t.innerHTML='<option value="" disabled>Cargando...</option>',t.disabled=!0,fetch(`/dashboard/soluciones/get-categorias?division_id=${e}`).then((e=>e.json())).then((e=>{t.innerHTML='<option value="" disabled>Seleccione categoría</option>',e.forEach((e=>{const o=new Option(e.nombre,e.id);(e.id="<?= json_encode($solucion[0]->categories ?? null) ?>")&&(o.selected=!0),t.appendChild(o)})),t.disabled=!1})).catch((e=>{console.error("Error:",e),t.innerHTML='<option value="" disabled>Error al cargar</option>'}))})),e.value&&e.dispatchEvent(new Event("change"));let o=new Quill("#editor",{theme:"snow",modules:{toolbar:[[{header:"1"},{header:"2"},{font:[]}],[{list:"ordered"},{list:"bullet"}],["bold","italic","underline"],[{align:[]}],["link","image"]],clipboard:!0}});function r(e){fetch("/dashboard/soluciones/editar",{method:"POST",body:e}).then((e=>e.json())).then((e=>{e.success?Swal.fire({icon:"success",title:"¡Éxito!",text:"La solución se guardó correctamente",confirmButtonText:"Aceptar"}).then((()=>{e.redirect&&(window.location.href=e.redirect)})):Swal.fire({icon:"error",title:"Error",text:e.message||"Error al guardar",confirmButtonText:"Aceptar"})})).catch((e=>{Swal.fire({icon:"error",title:"Error",text:"Error de conexión con el servidor",confirmButtonText:"Aceptar"}),console.error("Error:",e)}))}o.root.addEventListener("paste",(function(e){let t=(e.clipboardData||e.originalEvent.clipboardData).items;for(let e of t)if(0===e.type.indexOf("image")){let t=e.getAsFile(),r=new FileReader;r.onload=function(e){let t=e.target.result,r=o.getSelection();o.insertEmbed(r.index,"image",t)},r.readAsDataURL(t)}}));let n=document.getElementById("descripcionServidor").dataset.content,i=new Set;if(n){o.root.innerHTML=n,o.focus(),o.root.querySelectorAll("img").forEach((e=>{let t=e.getAttribute("src");t.startsWith("data:image")||i.add(t)}))}document.getElementById("formulario").addEventListener("submit",(function(e){e.preventDefault();let t=o.root.innerHTML,n=new FormData(this),a=o.root.querySelectorAll("img"),d=[];if(a.forEach((e=>{let t=e.getAttribute("src");t.startsWith("data:image")?d.push(t):i.has(t)||console.warn("Imagen desconocida detectada:",t)})),d.length>0){let e=d.map((e=>fetch("/dashboard/soluciones/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file:e})}).then((e=>e.json())).then((o=>(o.success&&(t=t.split(e).join(o.url)),o)))));Promise.all(e).then((()=>{n.set("descripcion",t),r(n)})).catch((e=>{console.error("Error al subir imágenes:",e),alert("Hubo un error al subir imágenes.")}))}else n.set("descripcion",t),r(n)}))}));
document.addEventListener("DOMContentLoaded",(e=>{const t=document.getElementById("division"),o=document.getElementById("categoria");t.addEventListener("change",(function(){const e=this.value;o.innerHTML='<option value="" disabled>Cargando...</option>',o.disabled=!0,fetch(`/dashboard/soluciones/get-categorias?division_id=${e}`).then((e=>e.json())).then((e=>{o.innerHTML='<option value="" disabled>Seleccione categoría</option>',e.forEach((e=>{const t=new Option(e.nombre,e.id);(e.id="<?= json_encode($solucion[0]->categories ?? null) ?>")&&(t.selected=!0),o.appendChild(t)})),o.disabled=!1})).catch((e=>{console.error("Error:",e),o.innerHTML='<option value="" disabled>Error al cargar</option>'}))})),t.value&&t.dispatchEvent(new Event("change"));let r=new Quill("#editor",{theme:"snow",modules:{toolbar:[[{header:"1"},{header:"2"},{font:[]}],[{list:"ordered"},{list:"bullet"}],["bold","italic","underline"],[{align:[]}],["link","image"]],clipboard:!0}});function n(e){fetch("/dashboard/soluciones/crear",{method:"POST",body:e}).then((e=>e.json())).then((e=>{e.success?Swal.fire({icon:"success",title:"¡Éxito!",text:"La solución se guardó correctamente",confirmButtonText:"Aceptar"}).then((()=>{e.redirect&&(window.location.href=e.redirect)})):Swal.fire({icon:"error",title:"Error",text:e.message||"Error al guardar",confirmButtonText:"Aceptar"})})).catch((e=>{Swal.fire({icon:"error",title:"Error",text:"Error de conexión con el servidor",confirmButtonText:"Aceptar"}),console.error("Error:",e)}))}r.root.addEventListener("paste",(function(e){let t=(e.clipboardData||e.originalEvent.clipboardData).items;for(let e of t)if(0===e.type.indexOf("image")){let t=e.getAsFile(),o=new FileReader;o.onload=function(e){let t=e.target.result,o=r.getSelection();r.insertEmbed(o.index,"image",t)},o.readAsDataURL(t)}})),document.getElementById("formulario").addEventListener("submit",(function(e){e.preventDefault();let t=r.root.innerHTML,o=new FormData(this),i=t.match(/<img[^>]+src="(data:image\/[^;]+;base64,[^"]+)"/g);if(i){let e=i.map((e=>{let o=e.match(/src="(data:image\/[^;]+;base64,[^"]+)"/)[1];return fetch("/dashboard/soluciones/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file:o})}).then((e=>e.json())).then((e=>(e.success&&(t=t.split(o).join(e.url)),e)))}));Promise.all(e).then((()=>{o.set("descripcion",t),n(o)})).catch((e=>{console.error("Detalles del error:",{error:e.message,stack:e.stack,base64:base64}),alert("Error al subir imágenes")}))}else o.set("descripcion",t),n(o)}))}));